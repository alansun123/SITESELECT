name: release-packaging

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows-exe:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller

      - name: Build CLI exe
        shell: pwsh
        run: |
          pyinstaller --onefile --name siteselect src/siteselect/cli.py
          $tag = "${{ github.ref_name }}"
          New-Item -ItemType Directory -Force -Path dist_out | Out-Null
          Copy-Item dist/siteselect.exe "dist_out/SITESELECT-$tag-windows-x64.exe"

      - name: Publish release asset (exe)
        uses: softprops/action-gh-release@v2
        with:
          files: dist_out/SITESELECT-${{ github.ref_name }}-windows-x64.exe

  build-macos-gui:
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13
            arch: x64
          - runner: macos-14
            arch: arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pyinstaller pillow

      - name: Build app icon (.icns)
        run: |
          python scripts/build_app_icon.py
          mkdir -p assets/SITESELECT.iconset
          sips -z 16 16 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_16x16.png
          sips -z 32 32 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_16x16@2x.png
          sips -z 32 32 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_32x32.png
          sips -z 64 64 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_32x32@2x.png
          sips -z 128 128 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_128x128.png
          sips -z 256 256 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_128x128@2x.png
          sips -z 256 256 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_256x256.png
          sips -z 512 512 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_256x256@2x.png
          sips -z 512 512 assets/siteselect_1024.png --out assets/SITESELECT.iconset/icon_512x512.png
          cp assets/siteselect_1024.png assets/SITESELECT.iconset/icon_512x512@2x.png
          iconutil -c icns assets/SITESELECT.iconset -o assets/siteselect.icns

      - name: Build GUI .app
        run: |
          pyinstaller \
            --windowed \
            --name "SITESELECT GUI" \
            --icon assets/siteselect.icns \
            --add-data "app:app" \
            --add-data "src:src" \
            scripts/gui_launcher.py

      - name: Package .app and .pkg
        run: |
          TAG="${GITHUB_REF_NAME}"
          ARCH="${{ matrix.arch }}"
          APP_NAME="SITESELECT GUI.app"
          APP_PATH="dist/${APP_NAME}"

          ditto -c -k --sequesterRsrc --keepParent "$APP_PATH" "SITESELECT-GUI-${TAG}-macos-${ARCH}.zip"

          pkgbuild \
            --component "$APP_PATH" \
            --install-location "/Applications" \
            --identifier "com.alansun.siteselect.gui" \
            --version "${TAG#v}" \
            "SITESELECT-GUI-${TAG}-macos-${ARCH}.pkg"

      - name: Publish release assets (GUI)
        uses: softprops/action-gh-release@v2
        with:
          files: |
            SITESELECT-GUI-${{ github.ref_name }}-macos-${{ matrix.arch }}.zip
            SITESELECT-GUI-${{ github.ref_name }}-macos-${{ matrix.arch }}.pkg
